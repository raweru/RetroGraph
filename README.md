![RetroGraph Logo](src/assets/rg_logo.png)

RetroGraph is a tool designed for the visualization and clustering of synthesis route trees. It processes collections of these trees, typically loaded from AiZynthFinder outputs, by first calculating Tree Edit Distance (TED) to measure similarity between them. This similarity data is then used to generate a tmap layout, which forms the basis for an interactive HTML visualization created with Faerun, allowing for intuitive exploration and analysis of the synthesis strategies.

## Features

*   Loads AiZynthFinder reaction trees from `.json.gz` files.
*   Converts AiZynthFinder trees to an internal `SynthesisTree` representation.
*   Calculates TED between trees using the `apted` library.
    *   Note: TED costs (delete, insert, rename) are currently defined as constants within `src/retrograph/config/ted_config.py`.
*   Generates a 2D layout using tmap, connecting similar trees based on a TED threshold.
*   Creates interactive HTML visualizations with Faerun, showing the tmap layout, tree structures on hover, and grouping by target molecule.
    *   The legend in the HTML output allows toggling the visibility of specific target molecules and can be minimized when not needed.

## Installation

1.  **Clone the repository:**
    ```bash
    git clone <your-repository-url>
    cd retrograph
    ```

2.  **Create and activate Conda environment:**
    Make sure you have Anaconda or Miniconda installed. Then create the environment using the appropriate file for your operating system:

    *   **Windows:**
        ```bash
        conda env create -f env_win.yml
        conda activate retrograph
        ```
    *   **Linux:**
        ```bash
        conda env create -f env_linux.yml
        conda activate retrograph
        ```

    **Note:** This tool has been tested on Windows 11 and Red Hat Linux.

## Usage

Run the main script, providing the path to your AiZynthFinder output file:

```bash
python retrograph.py <path/to/aizynthfinder_output.json.gz> [OPTIONS]
```

**Example:**

```bash
python retrograph.py output.json.gz --ted-threshold 3.0 --output my_visualization
```

**Options:**

*   `--ted-threshold`: Maximum TED for connecting trees (default: 3.0). Not used if `--visualize-all` is set.
*   `--ted-mode`: TED calculation mode for clustering or distance calculation (default: "shape")
    *   `shape`: Considers only tree structure and node types
    *   `classification_aware`: Considers reaction classifications for finer-grained similarity
*   `--visualize-all`: Visualize all trees in a global tmap layout without explicit TED threshold-based clustering
*   `--output`: Output file name prefix (without .html extension). Can include relative/absolute path
*   `--bg-color`: Background color for the Faerun plot (hex code)
*   `--title`: Title for the Faerun visualization
*   `--point-scale`: Scale factor for plotted points
*   `--max-point-size`: Maximum size of plotted points

**Point Scaling Recommendations:**
* For small datasets (around 100 trees): use `--point-scale 10 --max-point-size 100`
* For medium datasets: use smaller values, keeping max-point-size approximately 10x point-scale
* For large datasets: use `--point-scale 1 --max-point-size 10`

## Example Output

Here's an example of the interactive visualization generated by RetroGraph:

![Example RetroGraph Output](src/assets/example.png)

You can also explore pre-generated example visualizations html files in `/examples` folder in your web browser. Note that the `.js` files in the same folder are required for the visualization to work properly - make sure to keep them together with their corresponding HTML files.

## License

This project is licensed under the MIT License. See the [LICENSE.md](LICENSE.md) file for details. It incorporates code derived from the original `tmap` library, available at [https://github.com/reymond-group/tmap](https://github.com/reymond-group/tmap).
